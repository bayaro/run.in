#!/bin/sh

while true; do
    case "x$1" in
        "x-y") YES=1
            ;;
        "x-g") PATTERN=$2
            shift
            ;;
        *) break
            ;;
    esac
    shift
done

PROFILE=`basename $0 | sed -E 's/run.in.(.*).sh/\1/'`
echo ">>>>>> $@"

HOSTS=`aws --output text --profile $PROFILE --region eu-west-1 ec2 describe-instances \
    --query 'Reservations[*].[Instances[*].[PrivateIpAddress,NetworkInterfaces[*].PrivateIpAddresses,Tags,State.Name,Platform],Instances[*].InstanceId]'`
    #--instance-ids i-092ad220bf866af12 \
if [ $? -ne 0 ]; then
    exit 1
fi
HOSTS=`echo "$HOSTS" | grep -E '^(Env|Name|True\s*|10\.10|None|i-)'`
#echo "$HOSTS\n==" ; exit
HOSTS=`echo "$HOSTS" | awk '{
        if ( $0 ~ /^i\-[0-9a-f]*$/ ) {
            host["aid"] = $0
            next
        }
        split($0,a," ");
        if ( a[1] == "Name" ) { host[0] = a[2] }
        else if ( a[1] == "Environment" ) { host[1] = a[2] }
        else if ( a[1] == "True" ) {
            if ( a[3] != host["ip"] ) host[2] = host[2]","a[3]
        }
        else {
            if ( host["ip"] ) {
                printf "%s##%s##%s##%s##%s##%s##%s\n",host[1],host[0],host["ip"],host["state"],host["Platform"],host["aid"],host[2]
                delete host
            }
            host["ip"] = a[1]
            host["state"] = a[2]
            if ( a[3] == "None" ) a[3] = "-"
            host["Platform"] = a[3]
        }
    } END {
        printf "%s##%s##%s##%s##%s##%s##%s\n",host[1],host[0],host["ip"],host["state"],host["Platform"],host["aid"],host[2]
    }' | sort -g`
HOSTS=`echo "$HOSTS" | sed 's/##,/##/g'`
#echo "$HOSTS=="
if [ ! -z "$PATTERN" ]; then
    HOSTS=`echo "$HOSTS" | grep -E "$PATTERN"`
    if [ "x$HOSTS" == "x" ]; then
        echo "There are no hosts that contains '$PATTERN' in its description"
        exit 1
    fi
fi

if [ -z "$2" ] && [ "x$@" = "x" ]; then
    echo "$HOSTS" | sed 's/##/ /g' | sort -k 1 | awk -F ' ' '{printf "===> %-15s %20s %s: %s (%s %s) %s\n",$3,$6,$1,$2,$4,$5,$7}' | grep --colour -E "$PATTERN"
    exit 0
fi

add_key() {
    cat ~/.ssh/id_rsa.pub | ssh $host 'if [ ! -d .ssh ]; then mkdir .ssh; fi ; cat > ~/.ssh/authorized_keys'
}

for h in $HOSTS; do
    echo $h | sed 's/##/ /g' | awk -F ' ' '{printf "===> %-15s %20s %s: %s (%s %s) %s\n",$3,$6,$1,$2,$4,$5,$7}' | grep --colour -E "$PATTERN"
    state=`echo $h | awk -F '##' '{print $4}'`
    if [ "$state" != "running" ]; then continue; fi
    platform=`echo $h | awk -F '##' '{print $5}'`
    if [ "$platform" != "-" ]; then continue; fi

    env=`echo $h | awk -F '##' '{print $1}'`
    name=`echo $h | awk -F '##' '{print $2}'`
    ip=`echo $h | awk -F '##' '{print $3}'`
    otherip=`echo $h | awk -F '##' '{print $7}'`
    echo " $otherip"

    while [ true ]; do
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=2 $ip -qo PasswordAuthentication=no $@
        RES=$?
        if [ $RES -eq  0 ]; then break; fi

        echo "EROROR: $RES"
        if [ "x$otherip" != "x" ]; then
            ip=`echo "$otherip" | awk -F ',' '{print $1}'`
            otherip=`echo "$otherip" | sed -E 's/^[^,]*,*(.*)$/\1/'`
            echo "===> Using other ip $ip ..."
            continue
        fi

        echo "Continue? [y/N]"
        if [ "$YES" = "1" ]; then
            y=y
        else
            read y
        fi
        if [ "x$y" != "xy" ]; then
            echo "ABORTED"
            exit 1
        else
            break
        fi
        #if [ $? -ne 0 ]; then
        #    add_key
        #    ssh $ip $@
    done
done

echo "DONE"
